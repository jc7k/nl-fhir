# Story 4.1: Bundle Summarization & Plain-English Output

## Status
**Draft**

## Story
**As a** clinician or administrator reviewing processed clinical orders,  
**I want** to receive plain-English summaries of generated FHIR bundles that clearly explain what was processed and created,  
**so that** I can quickly understand and verify the accuracy of automated clinical order processing without needing to read complex FHIR resource structures.

## Acceptance Criteria

1. **Plain-English Summary Generation**: Create human-readable summaries of FHIR bundles using deterministic template-based approach
2. **Medical Context Preservation**: Maintain clinical context and reasoning from original natural language input in summaries
3. **Resource Coverage**: Summarize all FHIR resources in bundles (medications, procedures, lab orders, conditions)
4. **Confidence Indicators**: Include confidence scores and quality indicators for processed clinical orders
5. **Error and Warning Reporting**: Clearly communicate any processing issues, assumptions, or missing information
6. **Summary Personalization**: Tailor summary detail level based on user role (clinician vs administrator vs technical user)
7. **Performance Compliance**: Generate summaries within <2s total response time including FHIR processing

## Tasks / Subtasks

- [ ] **Task 1: Implement template-based summary engine** (AC: 1, 2)
  - [ ] Create summary templates for different clinical order types (medication, lab, procedure)
  - [ ] Implement template selection logic based on bundle content analysis
  - [ ] Add medical context integration from Epic 2 NLP processing results
  - [ ] Create natural language generation for clinical order descriptions
  - [ ] Implement summary formatting with proper medical terminology

- [ ] **Task 2: FHIR resource interpretation and translation** (AC: 3)
  - [ ] Create FHIR resource interpreters for each supported resource type
  - [ ] Implement MedicationRequest → plain English medication order summaries
  - [ ] Add ServiceRequest → laboratory/procedure order summaries
  - [ ] Create Condition → clinical condition/diagnosis summaries
  - [ ] Implement Patient/Practitioner → context summaries

- [ ] **Task 3: Confidence and quality reporting** (AC: 4, 5)
  - [ ] Integrate processing confidence scores from Epic 2 NLP pipeline
  - [ ] Add FHIR validation results and quality metrics to summaries
  - [ ] Create assumption tracking and explicit assumption reporting
  - [ ] Implement missing information detection and reporting
  - [ ] Add processing error and warning integration

- [ ] **Task 4: Role-based summary personalization** (AC: 6)
  - [ ] Create user role detection and summary customization
  - [ ] Implement clinician-focused summaries with medical detail
  - [ ] Add administrator summaries focused on compliance and completeness
  - [ ] Create technical summaries with processing details and metrics
  - [ ] Implement summary length and detail level controls

- [ ] **Task 5: Summary quality assurance** (AC: 1, 2)
  - [ ] Implement summary accuracy validation against original clinical input
  - [ ] Add medical terminology consistency checking
  - [ ] Create summary completeness validation
  - [ ] Implement clinical reasoning preservation verification
  - [ ] Add summary readability and clarity scoring

- [ ] **Task 6: Performance optimization** (AC: 7)
  - [ ] Profile summary generation performance with various bundle sizes
  - [ ] Optimize template processing and natural language generation
  - [ ] Implement summary caching for repeated bundle patterns
  - [ ] Add asynchronous processing for non-critical summary components
  - [ ] Monitor and maintain <2s total response time including summarization

- [ ] **Task 7: Integration with Epic 3 FHIR pipeline** (AC: All)
  - [ ] Integrate summary generation with Epic 3 FHIR bundle processing
  - [ ] Create /summarize-bundle endpoint accepting validated FHIR bundles
  - [ ] Preserve Epic 2 NLP context and Epic 3 validation results in summaries
  - [ ] Add summary generation to unified processing pipeline
  - [ ] Implement summary response format integration

- [ ] **Task 8: Testing and validation** (All ACs)
  - [ ] Create comprehensive summary generation tests with clinical scenarios
  - [ ] Test summary accuracy and completeness with medical experts
  - [ ] Validate role-based summary personalization
  - [ ] Integration testing with Epic 3 FHIR pipeline
  - [ ] Performance testing to ensure <2s response time compliance

## Dev Notes

### Integration with Epic 3 FHIR Pipeline
**Epic 3 → Epic 4 Data Flow**:
- **Epic 3 Output**: Validated FHIR bundles with processing metadata
- **Epic 4 Input**: Generate human-readable summaries of bundle content
- **Context Preservation**: Maintain Epic 2 NLP context and Epic 3 validation results
- **Summary Integration**: Combine technical processing with user-friendly presentation

### Summary Generation Architecture [Source: prd/5-functional-requirements.md#5.5]
**Template-Based Summary Approach**:
- **Deterministic Templates**: Primary approach for consistent, reliable summaries
- **Medical Context Integration**: Preserve clinical reasoning from NLP processing
- **Resource-Specific Templates**: Specialized templates for different FHIR resources
- **Quality Indicators**: Include confidence scores and processing quality metrics

### Summary Templates and Examples
**Medication Order Summary**:
```
Template: "Prescribed {medication_name} {strength} {dosage_form}, take {frequency} {route} for {indication}. Duration: {duration}."

Example: "Prescribed Metformin 500mg tablets, take twice daily by mouth for diabetes management. Duration: ongoing."

Quality Indicators: 
- Processing Confidence: 95%
- FHIR Validation: Passed
- Medical Code Mapping: RxNorm verified
```

**Laboratory Order Summary**:
```
Template: "Ordered {test_name} {specimen_type} collection {timing} to {indication}."

Example: "Ordered Complete Blood Count (CBC) blood collection tomorrow morning to evaluate for anemia."

Quality Indicators:
- Processing Confidence: 88%
- LOINC Code Mapping: Verified
- Timing: Specific date scheduled
```

### Role-Based Summary Personalization
**Summary Variations by User Role**:
```python
# Clinician Summary (Medical Focus)
"Prescribed Metformin 500mg BID PO for T2DM management with baseline A1C monitoring."

# Administrator Summary (Compliance Focus)  
"Medication order processed successfully with proper RxNorm coding and dosage validation. Ready for EHR integration."

# Technical Summary (Processing Focus)
"NLP confidence: 95%, FHIR validation: passed, RxNorm mapping: verified, processing time: 1.2s"
```

### Summary Quality Assurance Framework
**Summary Accuracy Validation**:
- **Clinical Accuracy**: Ensure medical information is correctly interpreted
- **Completeness**: Verify all important clinical details are included
- **Clarity**: Maintain readability for target user roles
- **Consistency**: Ensure consistent terminology and format across summaries

### Project Structure Enhancement
```
├── services/
│   ├── summarization/
│   │   ├── __init__.py
│   │   ├── summary_engine.py        # Main summary generation engine
│   │   ├── template_manager.py      # Summary template management
│   │   ├── fhir_interpreter.py      # FHIR resource interpretation
│   │   ├── role_personalizer.py     # Role-based customization
│   │   └── quality_assessor.py      # Summary quality validation
├── templates/
│   ├── summary_templates/
│   │   ├── medication_templates.py  # Medication summary templates
│   │   ├── lab_templates.py         # Laboratory order templates
│   │   ├── procedure_templates.py   # Procedure order templates
│   │   └── general_templates.py     # General summary templates
├── models/
│   ├── summary_models.py            # Summary response models
│   ├── template_models.py           # Template configuration models
│   └── personalization_models.py    # Role-based customization models
├── utils/
│   ├── medical_language.py          # Medical terminology utilities
│   ├── readability_utils.py         # Summary readability assessment
│   └── template_utils.py            # Template processing utilities
├── tests/
│   ├── summarization/
│   │   ├── test_summary_engine.py   # Summary generation tests
│   │   ├── test_templates.py        # Template processing tests
│   │   ├── test_personalization.py  # Role-based summary tests
│   │   └── test_integration.py      # Epic 3 integration tests
```

### API Integration
**New /summarize-bundle Endpoint** [Source: prd/5-functional-requirements.md#5.5]:
```python
POST /summarize-bundle
{
  "bundle": { /* Validated FHIR Bundle from Epic 3 */ },
  "user_role": "clinician|administrator|technical",
  "detail_level": "brief|standard|detailed"
}

Response: {
  "summary": {
    "plain_english_summary": "Prescribed Metformin 500mg...",
    "clinical_context": "Patient management for diabetes...",
    "processing_quality": {
      "confidence_score": 0.95,
      "validation_status": "passed",
      "assumptions_made": [],
      "missing_information": []
    }
  },
  "processing_metadata": {
    "summary_generation_time": "0.3s",
    "template_used": "medication_order_template",
    "personalization_applied": "clinician_focus"
  }
}
```

### Testing Strategy
**Summary-Specific Testing Requirements**:
- **Accuracy Testing**: Validate summaries against original clinical input
- **Role Testing**: Test personalization for different user roles
- **Medical Review**: Clinical expert validation of summary accuracy
- **Readability Testing**: Validate summary clarity and comprehension
- **Integration Testing**: End-to-end testing with Epic 3 pipeline

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation for Epic 4 summarization | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be populated here after implementation*