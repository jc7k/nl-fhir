# Story 4.1: Structured Clinical Summary Framework

## Story Overview

**Epic:** Epic 4 - FHIR Bundle Summarization  
**Story ID:** 4.1  
**Title:** Structured Clinical Summary Framework  
**Status:** Ready for Development  
**Estimate:** 5 story points  
**Sprint:** Sprint 4 Week 1  

## User Story

**As a** physician reviewing converted clinical orders  
**I want** consistent, structured clinical summaries from FHIR bundles  
**So that** I can quickly verify order accuracy without parsing varying text formats  

## Acceptance Criteria

### AC1: Dynamic Pydantic Schema Models
- [ ] **GIVEN** different types of FHIR bundles (medication-only, comprehensive, emergency)
- [ ] **WHEN** the system analyzes bundle content  
- [ ] **THEN** it selects the appropriate Pydantic schema for structured output
- [ ] **AND** each schema produces human-readable, natural clinical language

### AC2: Clinical Element Extraction  
- [ ] **GIVEN** a HAPI-validated FHIR bundle
- [ ] **WHEN** the system processes bundle resources
- [ ] **THEN** it extracts key clinical elements (medications, labs, procedures)
- [ ] **AND** converts structured FHIR data to natural language descriptions

### AC3: Human-Readable Field Definitions
- [ ] **GIVEN** extracted clinical data
- [ ] **WHEN** populating Pydantic model fields
- [ ] **THEN** all field values use natural clinical language
- [ ] **AND** avoid machine-readable codes or data structure formats

### AC4: Schema Selection Logic
- [ ] **GIVEN** various FHIR bundle compositions
- [ ] **WHEN** the bundle analyzer examines resources  
- [ ] **THEN** it correctly identifies complexity level and content type
- [ ] **AND** selects the most appropriate schema (MedicationOnly, Comprehensive, Emergency)

## Technical Requirements

### Pydantic Model Specifications

**MedicationOnlySummary:**
```python
class MedicationOnlySummary(BaseModel):
    summary_type: Literal["medication_orders"]
    patient_context: str  # e.g., "Adult patient with hypertension"
    medications: List[MedicationSummary]
    clinical_assessment: ClinicalAssessment
```

**ComprehensiveOrderSummary:**
```python  
class ComprehensiveOrderSummary(BaseModel):
    summary_type: Literal["comprehensive_orders"]
    patient_context: str
    medications: List[MedicationSummary] = []
    laboratory_orders: List[LaboratoryOrderSummary] = []
    procedures: List[ProcedureSummary] = []
    clinical_assessment: ClinicalAssessment
    coordination_notes: Optional[str]
```

**EmergencyOrderSummary:**
```python
class EmergencyOrderSummary(BaseModel):
    summary_type: Literal["emergency_orders"]
    urgency_level: Literal["urgent", "stat", "emergent"]
    patient_context: str
    immediate_orders: List[Union[MedicationSummary, LaboratoryOrderSummary, ProcedureSummary]]
    clinical_assessment: ClinicalAssessment
    critical_actions: List[str] = []
```

### Bundle Analysis Logic

**Content Analysis:**
- Detect resource types (MedicationRequest, ServiceRequest, Observation)
- Identify urgency indicators (priority fields, emergency keywords)  
- Count resources for complexity assessment
- Check for high-risk medications or procedures

**Schema Selection Rules:**
- **MedicationOnlySummary:** ≤3 resources, medications only, no urgency
- **EmergencyOrderSummary:** Any urgent/stat priority indicators
- **ComprehensiveOrderSummary:** Default for complex or mixed resource bundles

## Implementation Details

### File Structure
```
src/nl_fhir/services/
├── structured_clinical_summary.py     # Main service class
├── clinical_summary_models.py         # Pydantic model definitions  
├── bundle_analyzer.py                 # FHIR bundle analysis logic
└── clinical_element_extractor.py      # Extract elements from FHIR resources
```

### Key Classes

**SchemaSelector:**
```python
class SchemaSelector:
    @staticmethod
    def analyze_bundle_content(fhir_bundle: Dict) -> Dict[str, Any]:
        # Analyze bundle composition and complexity
        
    @staticmethod  
    def select_schema(bundle_analysis: Dict) -> type[BaseModel]:
        # Select appropriate Pydantic schema
```

**ClinicalElementExtractor:**
```python
class ClinicalElementExtractor:
    def extract_medication_info(self, medication_request: Dict) -> Dict:
        # Convert FHIR MedicationRequest to natural language
        
    def extract_lab_info(self, service_request: Dict) -> Dict:
        # Convert FHIR ServiceRequest (lab) to natural language
```

## Testing Requirements

### Unit Tests
- [ ] Test schema selection logic with various FHIR bundle types
- [ ] Validate Pydantic model structure and field requirements
- [ ] Test clinical element extraction accuracy
- [ ] Verify natural language conversion from FHIR structured data

### Integration Tests  
- [ ] End-to-end bundle analysis → schema selection → structured output
- [ ] Test with real FHIR bundles from Epic 3 output
- [ ] Validate consistency across multiple runs with same input

### Test Data
- Simple medication bundle (should select MedicationOnlySummary)
- Complex multi-resource bundle (should select ComprehensiveOrderSummary)  
- Emergency priority bundle (should select EmergencyOrderSummary)
- Edge cases: empty bundles, single resources, mixed priorities

## Definition of Done

- [ ] All Pydantic models defined with proper field types and descriptions
- [ ] Schema selection logic implemented and tested with >95% accuracy
- [ ] Clinical element extraction converts FHIR data to natural language
- [ ] Bundle analyzer correctly identifies content types and complexity
- [ ] Unit tests achieve >90% code coverage
- [ ] Integration tests validate end-to-end functionality
- [ ] Code review completed and approved
- [ ] Documentation updated with model specifications and usage examples

## Dependencies

**Blocked By:**
- Epic 3 completion (HAPI-validated FHIR bundles)

**Blocks:**
- Story 4.2 (LLM Integration) - requires Pydantic models
- Story 4.3 (FHIR Bundle Analysis) - requires schema selection logic

**External Dependencies:**
- Pydantic v2 library
- Python typing support for Literal types

## Notes for Development

**Key Design Principles:**
1. **Human-First:** All field values should read naturally for clinicians
2. **Consistency:** Same FHIR bundle should always produce same structured output  
3. **Flexibility:** Schema selection adapts to different clinical scenarios
4. **Validation:** Pydantic enforces required fields and data types

**Implementation Priority:**
1. Define core Pydantic models with proper field types
2. Implement FHIR resource parsing for clinical elements  
3. Build schema selection logic with bundle analysis
4. Test with variety of FHIR bundle compositions

**Clinical Review Requirements:**
- Physician review of field definitions and natural language conversion
- Validation that summaries support clinical decision-making
- Confirmation that structured output maintains clinical meaning