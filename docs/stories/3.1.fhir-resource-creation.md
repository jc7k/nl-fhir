# Story 3.1: FHIR Resource Creation & Mapping

## Status
**Draft**

## Story
**As a** FHIR bundle assembly system,  
**I want** to convert structured medical data from the NLP pipeline (Epic 2) into valid FHIR R4 resources,  
**so that** clinical orders can be represented as standardized FHIR resources (Patient, Practitioner, MedicationRequest, ServiceRequest, Observation, Encounter) ready for bundle assembly and EHR integration.

## Acceptance Criteria

1. **FHIR Resource Templates**: Create FHIR R4 resource templates for all supported resource types (Patient, Practitioner, MedicationRequest, ServiceRequest, Observation, Encounter)
2. **NLP Data Mapping**: Map structured medical data from Epic 2 pipeline output to appropriate FHIR resource fields
3. **Medical Code Integration**: Integrate standardized medical codes (RxNorm, LOINC, ICD-10) from Epic 2 RAG processing into FHIR CodeableConcept structures
4. **Resource Validation**: Implement FHIR R4 schema validation for created resources using fhir.resources library
5. **Reference Management**: Create and manage FHIR resource references and relationships between resources
6. **Error Handling**: Handle FHIR resource creation failures with detailed error reporting and fallback strategies
7. **Performance Optimization**: Ensure FHIR resource creation maintains <2s total response time requirement

## Tasks / Subtasks

- [ ] **Task 1: Setup FHIR resource infrastructure** (AC: 1, 4)
  - [ ] Install and configure fhir.resources library for FHIR R4 schema validation
  - [ ] Create FHIR resource factory classes for each supported resource type
  - [ ] Implement FHIR resource templates with required and optional fields
  - [ ] Add FHIR schema validation framework with detailed error reporting
  - [ ] Create FHIR resource serialization and deserialization utilities

- [ ] **Task 2: Implement NLP to FHIR data mapping** (AC: 2)
  - [ ] Create mapping logic from Epic 2 NLP output to FHIR resource fields
  - [ ] Implement medication order → MedicationRequest resource mapping
  - [ ] Create laboratory order → ServiceRequest resource mapping
  - [ ] Add condition/diagnosis → Condition resource mapping
  - [ ] Implement procedure order → ServiceRequest/Procedure resource mapping
  - [ ] Create patient context → Patient resource mapping

- [ ] **Task 3: Integrate medical terminology with FHIR CodeableConcepts** (AC: 3)
  - [ ] Convert RxNorm codes to FHIR CodeableConcept structures for medications
  - [ ] Map LOINC codes to FHIR CodeableConcept for laboratory tests
  - [ ] Create ICD-10 CodeableConcept mappings for conditions
  - [ ] Implement FHIR ValueSet validation for medical codes
  - [ ] Add fallback text descriptions when codes are unavailable

- [ ] **Task 4: Implement FHIR reference management** (AC: 5)
  - [ ] Create FHIR resource ID generation and management system
  - [ ] Implement resource reference creation (Patient → MedicationRequest references)
  - [ ] Add contained resource handling for complex scenarios
  - [ ] Create reference validation to ensure referential integrity
  - [ ] Implement resource linking strategies for bundle assembly

- [ ] **Task 5: FHIR validation and error handling** (AC: 4, 6)
  - [ ] Implement comprehensive FHIR resource validation using fhir.resources
  - [ ] Create detailed validation error reporting with field-level feedback
  - [ ] Add FHIR profile validation for specific use cases
  - [ ] Implement fallback strategies for validation failures
  - [ ] Create resource quality scoring and completeness metrics

- [ ] **Task 6: Performance optimization for FHIR processing** (AC: 7)
  - [ ] Profile FHIR resource creation performance with various data loads
  - [ ] Optimize resource creation and validation processes
  - [ ] Implement caching for FHIR templates and validation schemas
  - [ ] Add parallel processing for multiple resource creation
  - [ ] Monitor and maintain <2s total response time including FHIR processing

- [ ] **Task 7: Testing and validation** (All ACs)
  - [ ] Create comprehensive FHIR resource creation tests with medical scenarios
  - [ ] Test NLP to FHIR mapping accuracy with clinical examples
  - [ ] Validate FHIR R4 compliance for all created resources
  - [ ] Integration testing with Epic 2 NLP pipeline output
  - [ ] Performance testing to ensure <2s response time compliance

## Dev Notes

### Integration with Epic 2 NLP Pipeline
**Epic 2 → Epic 3 Data Flow**:
- **Epic 2 Output**: Structured medical data with entities, terminology codes, and clinical context
- **Epic 3 Input**: Transform structured data into FHIR-compliant resources
- **Resource Mapping**: Direct mapping from NLP entities to FHIR resource fields
- **Code Integration**: Seamless integration of RxNorm/LOINC/ICD-10 codes into FHIR structures

### FHIR R4 Resource Architecture [Source: prd/5-functional-requirements.md#5.3]
**Supported FHIR Resources**:
- **Patient** - Patient demographics and identifiers
- **Practitioner** - Healthcare provider information
- **MedicationRequest** - Medication orders with dosage, frequency, duration
- **ServiceRequest** - Laboratory tests, procedures, imaging orders
- **Observation** - Clinical observations and measurements
- **Encounter** - Clinical encounter context for orders

### Medical Code to FHIR Mapping [Source: CLAUDE.md#Technical-Specifications]
**FHIR CodeableConcept Integration**:
```python
# Example RxNorm → FHIR CodeableConcept
{
  "coding": [
    {
      "system": "http://www.nlm.nih.gov/research/umls/rxnorm",
      "code": "6809",
      "display": "Metformin"
    }
  ],
  "text": "Metformin 500mg tablets"
}

# Example LOINC → FHIR CodeableConcept  
{
  "coding": [
    {
      "system": "http://loinc.org",
      "code": "58410-2", 
      "display": "CBC panel - Blood by Automated count"
    }
  ],
  "text": "Complete Blood Count"
}
```

### FHIR Resource Creation Architecture
```
Epic 2 NLP Output
    ↓
FHIR Resource Factory
    ├── Patient Resource Creation
    ├── Practitioner Resource Creation  
    ├── MedicationRequest Creation (with RxNorm codes)
    ├── ServiceRequest Creation (with LOINC codes)
    ├── Condition Creation (with ICD-10 codes)
    └── Encounter Context Creation
    ↓
FHIR R4 Schema Validation
    ↓
Validated FHIR Resources
    ↓ (Ready for Story 3.2)
FHIR Bundle Assembly
```

### Performance and HIPAA Considerations
**FHIR Processing Requirements**:
- **<2s total response time** - Including NLP processing + FHIR resource creation
- **HIPAA Compliance** - Proper handling of PHI in FHIR resources
- **Resource Validation** - All resources must pass FHIR R4 schema validation
- **Error Handling** - Graceful handling of incomplete or invalid medical data

### Project Structure Enhancement
Building on Epic 1 and Epic 2:
```
├── services/
│   ├── fhir/
│   │   ├── __init__.py
│   │   ├── resource_factory.py      # FHIR resource creation
│   │   ├── resource_mapper.py       # NLP → FHIR mapping logic
│   │   ├── reference_manager.py     # FHIR reference handling
│   │   └── validator.py             # FHIR validation framework
├── models/
│   ├── fhir_resources.py           # FHIR resource models and templates
│   └── mapping_models.py           # NLP to FHIR mapping structures
├── utils/
│   ├── fhir_utils.py               # FHIR utility functions
│   ├── code_mappers.py             # Medical code to FHIR conversions
│   └── fhir_validators.py          # FHIR-specific validation utilities
├── tests/
│   ├── fhir/
│   │   ├── test_resource_creation.py # FHIR resource creation tests
│   │   ├── test_mapping.py           # NLP to FHIR mapping tests
│   │   ├── test_validation.py        # FHIR validation tests
│   │   └── test_integration.py       # Epic 2 integration tests
```

### Testing Strategy
**FHIR-Specific Testing Requirements**:
- **Resource Validation**: All created resources must pass FHIR R4 validation
- **Mapping Accuracy**: Validate NLP data correctly maps to FHIR fields
- **Medical Code Integration**: Test RxNorm/LOINC/ICD-10 code inclusion
- **Reference Integrity**: Validate FHIR resource references and relationships
- **Performance Testing**: Ensure FHIR processing maintains <2s requirement

**Clinical FHIR Test Cases**:
```
"Medication order → MedicationRequest with proper RxNorm codes"
"Laboratory order → ServiceRequest with LOINC codes"  
"Condition diagnosis → Condition resource with ICD-10 codes"
"Complex multi-resource scenarios with proper references"
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation for Epic 3 FHIR resources | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be populated here after implementation*