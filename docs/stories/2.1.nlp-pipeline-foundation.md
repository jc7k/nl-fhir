# Story 2.1: NLP Pipeline Foundation & spaCy Integration

## Status
**Draft**

## Story
**As a** developer implementing the NL-FHIR conversion system,  
**I want** to integrate spaCy and medspaCy for medical entity recognition and rule extraction from clinical text,  
**so that** natural language clinical orders can be parsed into structured medical entities that prepare for FHIR resource creation.

## Acceptance Criteria

1. **spaCy/medspaCy Integration**: Install and configure spaCy with medspaCy/scispaCy models for medical entity recognition
2. **Entity Extraction Pipeline**: Create NLP pipeline that extracts medical entities (medications, dosages, frequencies, conditions) from clinical text
3. **Structured Output**: Transform extracted entities into structured format that maps to future FHIR resource types
4. **Convert Endpoint Integration**: Integrate NLP pipeline into existing `/convert` endpoint from Epic 1 Stories
5. **Error Handling**: Handle NLP processing failures gracefully with fallback mechanisms and detailed error reporting
6. **Performance Optimization**: Ensure NLP processing stays within performance requirements (<2s total response time)
7. **Medical Entity Validation**: Basic validation of extracted medical entities for completeness and accuracy

## Tasks / Subtasks

- [ ] **Task 1: Setup spaCy and medspaCy environment** (AC: 1)
  - [ ] Install spaCy, medspaCy, and scispaCy packages with appropriate versions
  - [ ] Download and configure medical language models (en_core_sci_sm, en_ner_bc5cdr_md)
  - [ ] Create NLP model initialization and caching system
  - [ ] Add error handling for model loading failures
  - [ ] Configure memory management for NLP models

- [ ] **Task 2: Design NLP pipeline architecture** (AC: 2, 3)
  - [ ] Create NLP service class with entity extraction methods
  - [ ] Implement medical entity recognition (PERSON, MEDICATION, DOSAGE, FREQUENCY, CONDITION)
  - [ ] Add rule-based extraction for clinical patterns (dosage formats, timing expressions)
  - [ ] Create entity confidence scoring and filtering
  - [ ] Design structured output format mapping to FHIR resource types

- [ ] **Task 3: Integrate with existing convert endpoint** (AC: 4)
  - [ ] Modify convert endpoint to call NLP pipeline after input validation
  - [ ] Update response models to include extracted entities
  - [ ] Preserve request correlation and logging from Epic 1
  - [ ] Integrate with existing error handling framework
  - [ ] Update API documentation to reflect NLP-enhanced responses

- [ ] **Task 4: Implement comprehensive error handling** (AC: 5)
  - [ ] Handle NLP model loading failures with graceful degradation
  - [ ] Add timeout handling for long NLP processing
  - [ ] Create fallback mechanisms for entity extraction failures
  - [ ] Implement detailed error logging with entity extraction context
  - [ ] Add retry logic for transient NLP processing errors

- [ ] **Task 5: Performance optimization and monitoring** (AC: 6)
  - [ ] Profile NLP pipeline performance with various text lengths
  - [ ] Implement NLP processing caching for repeated patterns
  - [ ] Add performance monitoring specific to NLP operations
  - [ ] Optimize memory usage and model loading strategies
  - [ ] Ensure total response time stays under 2s requirement

- [ ] **Task 6: Medical entity validation framework** (AC: 7)
  - [ ] Create validation rules for extracted medication names (basic drug name patterns)
  - [ ] Implement dosage format validation (numeric values with units)
  - [ ] Add frequency pattern validation (daily, twice daily, etc.)
  - [ ] Create entity completeness scoring
  - [ ] Add validation result reporting in API responses

- [ ] **Task 7: Testing and validation** (All ACs)
  - [ ] Create comprehensive NLP pipeline tests with medical text examples
  - [ ] Test entity extraction accuracy with clinical order samples
  - [ ] Performance testing to ensure <2s response time requirement
  - [ ] Integration testing with Epic 1 convert endpoint
  - [ ] Error scenario testing for all failure modes

## Dev Notes

### Integration with Epic 1 Foundation
**Epic 1 Integration Points**:
- **Convert Endpoint Enhancement**: Build upon existing `/convert` endpoint from Story 1.2
- **Request/Response Models**: Extend existing Pydantic models to include extracted entities
- **Logging Framework**: Integrate with HIPAA-compliant logging from Story 1.2
- **Error Handling**: Extend existing error handling framework for NLP-specific failures
- **Performance Monitoring**: Build upon existing response time measurement

### NLP Technology Stack [Source: prd/5-functional-requirements.md#5.2, prd/7-dependencies.md]
**Core NLP Dependencies**:
- **spaCy** - Industrial-strength Natural Language Processing
- **medspaCy/scispaCy** - Medical/scientific domain-specific models and components
- **en_core_sci_sm** - Small scientific English model for basic processing
- **en_ner_bc5cdr_md** - Biomedical named entity recognition model

**Optional Components** (Future Stories):
- **ChromaDB** - Vector database for RAG terminology lookup (Story 2.2)
- **PydanticAI/Instructor** - Schema-constrained LLM outputs (Story 2.3)

### Medical Entity Types and FHIR Mapping
**Target Medical Entities**:
```
PERSON → Patient, Practitioner resources
MEDICATION → MedicationRequest resource
DOSAGE → MedicationRequest.dosageInstruction
FREQUENCY → MedicationRequest.dosageInstruction.timing
CONDITION → Condition, ServiceRequest resources
PROCEDURE → ServiceRequest, Procedure resources
LAB_TEST → ServiceRequest, Observation resources
```

### Performance Requirements [Source: CLAUDE.md#Performance-Requirements]
**Critical Performance Constraints**:
- **<2s API response time** - Total end-to-end including NLP processing
- **Memory efficiency** - NLP models can be memory-intensive
- **Model loading optimization** - Cache models, avoid repeated loading
- **Processing efficiency** - Optimize for typical clinical order lengths

### Security and HIPAA Considerations
**PHI Handling in NLP Pipeline**:
- **No PHI in logs** - Use entity type logging, not actual extracted values
- **Memory management** - Secure cleanup of processed clinical text
- **Entity sanitization** - Remove or mask PHI in debug outputs
- **Audit trails** - Log entity extraction operations without exposing content

### Project Structure Evolution
Building on Epic 1 structure:
```
├── services/
│   ├── conversion.py           # Enhanced with NLP integration
│   ├── nlp/
│   │   ├── __init__.py
│   │   ├── pipeline.py         # Main NLP pipeline
│   │   ├── entity_extractor.py # Medical entity extraction
│   │   ├── models.py           # NLP model management
│   │   └── validators.py       # Medical entity validation
├── models/
│   ├── nlp_models.py           # NLP-specific response models
│   └── entities.py             # Medical entity data structures
├── utils/
│   ├── nlp_utils.py            # NLP utility functions
│   └── medical_patterns.py     # Clinical text patterns
├── tests/
│   ├── nlp/
│   │   ├── test_pipeline.py    # NLP pipeline tests
│   │   ├── test_entities.py    # Entity extraction tests
│   │   └── test_integration.py # Epic 1 integration tests
├── requirements/
│   └── nlp.txt                 # NLP-specific dependencies
```

### Testing Strategy
**NLP-Specific Testing Requirements**:
- **Entity Extraction Accuracy**: Test with variety of clinical order formats
- **Performance Testing**: Ensure NLP processing meets <2s requirement
- **Medical Text Variations**: Test different clinical writing styles
- **Error Recovery**: Test NLP model failures and timeouts
- **Integration Testing**: Verify seamless integration with Epic 1 components

**Clinical Text Test Examples**:
```
"Start patient John Doe on 500 mg amoxicillin twice daily"
"Order CBC for patient Jane Smith tomorrow morning"
"Prescribe metformin 850mg daily for diabetes management"
"Schedule chest X-ray for chronic cough evaluation"
```

### Future Epic Preparation
**Epic 3 - FHIR Bundle Assembly Integration**:
- Extracted entities structure designed for FHIR resource mapping
- Entity validation framework prepares for FHIR validation requirements
- Performance optimization leaves headroom for FHIR processing

**Story 2.2 Preparation**:
- NLP pipeline foundation ready for RAG terminology lookup enhancement
- Entity extraction framework ready for ChromaDB integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation for Epic 2 NLP Pipeline | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*