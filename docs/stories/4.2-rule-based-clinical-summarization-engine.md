# Story 4.2: Rule-Based Clinical Summarization Engine

## Story Overview

**Epic:** Epic 4 - FHIR Bundle Summarization with Adaptive Cost Optimization  
**Story ID:** 4.2  
**Title:** Rule-Based Clinical Summarization Engine  
**Status:** Ready for Development  
**Estimate:** 10 story points  
**Sprint:** Sprint 4 Week 2-3  

## User Story

**As a** healthcare system administrator  
**I want** deterministic, rule-based FHIR resource summarization for common clinical scenarios  
**So that** we can process 70-80% of clinical summaries without LLM costs while maintaining clinical accuracy and consistency  

## Acceptance Criteria

### AC1: Core Resource Summarizers Implementation
- [ ] **GIVEN** common FHIR resources (MedicationRequest, ServiceRequest, Procedure, DiagnosticReport)
- [ ] **WHEN** the rule-based engine processes these resources  
- [ ] **THEN** it generates natural language summaries using deterministic clinical templates
- [ ] **AND** maintains 100% consistency for identical resource inputs

### AC2: Clinical Terminology Mapping  
- [ ] **GIVEN** FHIR resources with coded medical terminology (RxNorm, LOINC, ICD-10)
- [ ] **WHEN** rule-based summarizers process medication codes, lab codes, or procedure codes
- [ ] **THEN** they convert codes to readable clinical terminology without external API calls
- [ ] **AND** provide fallback descriptions when specific codes are unknown

### AC3: Template-Based Natural Language Generation
- [ ] **GIVEN** extracted FHIR resource data (dosage, frequency, indications)
- [ ] **WHEN** generating clinical descriptions
- [ ] **THEN** use pre-built clinical language templates for natural, professional output
- [ ] **AND** ensure output readability matches physician-written summaries

### AC4: Performance and Cost Optimization
- [ ] **GIVEN** high-volume clinical processing requirements
- [ ] **WHEN** rule-based summarizers handle supported resource types
- [ ] **THEN** achieve <100ms processing time per resource with zero external API costs
- [ ] **AND** successfully process 70-80% of typical clinical bundles without LLM fallback

## Technical Requirements

### Core Resource Summarizer Implementations

**MedicationSummarizer:**
```python
class MedicationSummarizer(BaseResourceSummarizer):
    """
    Rule-based summarization for MedicationRequest resources
    Handles dosage, frequency, route, indications with clinical templates
    """
    
    def summarize_resource(self, medication_request: Dict) -> MedicationSummary:
        # Extract medication details using deterministic rules
        medication_name = self._extract_medication_name(medication_request)
        dosage_info = self._extract_dosage_info(medication_request)
        frequency = self._extract_frequency(medication_request)
        route = self._extract_route(medication_request)
        
        # Generate natural language using clinical templates
        return self._generate_medication_summary(
            medication_name, dosage_info, frequency, route
        )
    
    def _extract_medication_name(self, resource: Dict) -> str:
        # Rule-based medication name extraction with RxNorm mapping
        
    def _generate_medication_summary(self, name, dosage, frequency, route) -> str:
        # Template: "Prescribe [medication] [dosage] [route] [frequency]"
```

**ServiceSummarizer (Labs & Procedures):**
```python
class ServiceSummarizer(BaseResourceSummarizer):
    """
    Rule-based summarization for ServiceRequest resources
    Handles laboratory orders, imaging studies, and clinical procedures
    """
    
    def summarize_resource(self, service_request: Dict) -> ServiceSummary:
        service_type = self._classify_service_type(service_request)
        
        if service_type == "laboratory":
            return self._summarize_lab_order(service_request)
        elif service_type == "imaging":
            return self._summarize_imaging_order(service_request)
        elif service_type == "procedure":  
            return self._summarize_procedure_order(service_request)
        else:
            return self._generate_generic_service_summary(service_request)
    
    def _summarize_lab_order(self, resource: Dict) -> ServiceSummary:
        # LOINC code mapping and clinical template application
```

**DiagnosticSummarizer:**
```python
class DiagnosticSummarizer(BaseResourceSummarizer):
    """
    Rule-based summarization for DiagnosticReport and Observation resources  
    Processes lab results, vital signs, and diagnostic findings
    """
    
    def summarize_resource(self, diagnostic_report: Dict) -> DiagnosticSummary:
        findings = self._extract_key_findings(diagnostic_report)
        interpretations = self._extract_interpretations(diagnostic_report)
        
        return self._generate_diagnostic_summary(findings, interpretations)
    
    def _extract_key_findings(self, resource: Dict) -> List[Finding]:
        # Rule-based extraction of abnormal values and critical results
```

### Clinical Terminology Management

**TerminologyMapper:**
```python
class TerminologyMapper:
    """
    Local terminology mapping to avoid external API dependencies
    Maintains curated mappings for common clinical codes
    """
    
    def __init__(self):
        self.rxnorm_mappings = self._load_rxnorm_mappings()
        self.loinc_mappings = self._load_loinc_mappings()  
        self.icd10_mappings = self._load_icd10_mappings()
    
    def map_medication_code(self, rxnorm_code: str) -> str:
        # Return readable medication name or generic fallback
        
    def map_lab_code(self, loinc_code: str) -> str:
        # Return readable lab test name or generic fallback
        
    def map_diagnosis_code(self, icd10_code: str) -> str:
        # Return readable diagnosis description or generic fallback

    def _load_rxnorm_mappings(self) -> Dict[str, str]:
        # Load curated RxNorm code mappings from local data files
        # Focus on most common 1000+ medications for cost optimization
```

### Clinical Language Templates

**ClinicalTemplateEngine:**
```python
class ClinicalTemplateEngine:
    """
    Template-based natural language generation for clinical summaries
    Provides consistent, professional clinical language patterns
    """
    
    MEDICATION_TEMPLATES = {
        'oral_daily': "Prescribe {medication} {dose} orally once daily",
        'oral_bid': "Prescribe {medication} {dose} orally twice daily", 
        'prn': "Prescribe {medication} {dose} as needed for {indication}",
        'injection': "Administer {medication} {dose} via {route} injection"
    }
    
    LAB_ORDER_TEMPLATES = {
        'routine_labs': "Order {test_name} - routine monitoring", 
        'diagnostic_labs': "Order {test_name} to evaluate {indication}",
        'followup_labs': "Order {test_name} for treatment follow-up"
    }
    
    def generate_medication_text(self, template_key: str, **kwargs) -> str:
        # Apply clinical template with resource-specific data
        
    def generate_lab_order_text(self, template_key: str, **kwargs) -> str:
        # Generate natural lab order descriptions
```

## Implementation Details

### File Structure
```
src/nl_fhir/services/summarization/rule_based/
├── __init__.py                       # Registry exports
├── base_summarizer.py                # Abstract base class and interfaces
├── medication_summarizer.py          # MedicationRequest processing
├── service_summarizer.py             # ServiceRequest processing  
├── diagnostic_summarizer.py          # DiagnosticReport & Observation processing
├── procedure_summarizer.py           # Procedure resource processing
├── terminology/                      # Clinical code mappings
│   ├── terminology_mapper.py         # Core mapping functionality
│   ├── rxnorm_mappings.py            # Medication code mappings
│   ├── loinc_mappings.py             # Lab test code mappings
│   └── icd10_mappings.py             # Diagnosis code mappings  
├── templates/                        # Clinical language templates
│   ├── clinical_templates.py         # Template engine and patterns
│   ├── medication_templates.py       # Medication-specific templates
│   └── procedure_templates.py        # Procedure-specific templates
└── data/                             # Local terminology data files
    ├── common_medications.json       # Top 1000 medications with descriptions
    ├── common_lab_tests.json         # Common LOINC codes with descriptions
    └── common_diagnoses.json         # Common ICD-10 codes with descriptions
```

### Base Resource Summarizer Interface

**BaseResourceSummarizer:**
```python
from abc import ABC, abstractmethod

class BaseResourceSummarizer(ABC):
    """
    Abstract base class for all rule-based resource summarizers
    Ensures consistent interface and behavior across implementations
    """
    
    def __init__(self):
        self.terminology_mapper = TerminologyMapper()
        self.template_engine = ClinicalTemplateEngine()
    
    @abstractmethod
    def summarize_resource(self, fhir_resource: Dict) -> ResourceSummary:
        """Generate natural language summary for FHIR resource"""
        pass
    
    @abstractmethod
    def supports_resource_type(self, resource_type: str) -> bool:
        """Check if summarizer supports given FHIR resource type"""
        pass
    
    def _extract_coding_display(self, coding: Dict) -> str:
        """Utility to extract human-readable display from FHIR Coding"""
        if 'display' in coding:
            return coding['display']
        elif 'code' in coding:
            return self.terminology_mapper.map_code(coding['system'], coding['code'])
        else:
            return "Unknown"
```

## Testing Requirements

### Unit Tests
- [ ] Test each resource summarizer with comprehensive FHIR resource examples
- [ ] Validate terminology mapping accuracy for common medical codes  
- [ ] Test clinical template generation with various parameter combinations
- [ ] Verify consistent output for identical FHIR resource inputs (deterministic behavior)

### Performance Tests
- [ ] Benchmark processing time for individual resources (<100ms target)
- [ ] Load testing with high-volume resource processing scenarios
- [ ] Memory usage validation for terminology mapping data structures

### Integration Tests  
- [ ] End-to-end testing with ResourceSummarizerRegistry integration
- [ ] Validate rule-based processing covers target 70-80% of clinical bundles
- [ ] Test graceful degradation when resource types are unsupported

### Clinical Validation Tests
- [ ] Physician review of generated summaries for clinical accuracy
- [ ] Comparison testing between rule-based and LLM-generated summaries
- [ ] Terminology mapping validation for medical accuracy

## Definition of Done

- [ ] All core resource summarizers implemented (Medication, Service, Diagnostic, Procedure)
- [ ] Clinical terminology mapping covers common codes (1000+ medications, labs, diagnoses)
- [ ] Template engine generates natural, clinically appropriate language
- [ ] Performance targets achieved (<100ms per resource, 70-80% coverage)
- [ ] Comprehensive test suite with >90% code coverage
- [ ] Clinical validation completed with physician approval
- [ ] Integration with ResourceSummarizerRegistry completed
- [ ] Documentation includes clinical template examples and terminology coverage
- [ ] Code review completed and approved

## Dependencies

**Blocked By:**
- Story 4.1 (Adaptive Framework) - requires ResourceSummarizerRegistry

**Blocks:**
- Story 4.4 (LLM Integration) - provides fallback coverage data for tier optimization

**External Dependencies:**
- Local clinical terminology data files (RxNorm, LOINC, ICD-10 subsets)
- Python dataclasses for summary models
- JSON data loading utilities

## Notes for Development

**Clinical Accuracy Priorities:**
1. **Medication Safety:** Ensure accurate dosage, frequency, and route descriptions
2. **Lab Result Interpretation:** Handle critical values and reference ranges appropriately  
3. **Procedure Clarity:** Generate clear, actionable procedure instructions
4. **Terminology Consistency:** Use standard clinical language and terminology

**Cost Optimization Strategy:**
- Target processing of 1000+ most common medications, lab tests, and procedures
- Optimize for high-frequency clinical scenarios to maximize LLM cost savings
- Use local terminology data to eliminate external API dependencies and costs
- Implement efficient caching and lookup strategies for terminology mapping

**Extensibility Design:**
- Registry pattern enables easy addition of new resource summarizers
- Template system allows customization of clinical language patterns
- Terminology mapper supports addition of new code systems and mappings
- Base class ensures consistent behavior across all summarizer implementations

**Quality Assurance:**
- Deterministic processing ensures identical inputs produce identical outputs
- Template validation prevents generation of clinically inappropriate summaries
- Comprehensive error handling for malformed or incomplete FHIR resources
- Clinical review process validates medical accuracy and appropriateness