# Story 2.5.2: Clinical Context Detection Integration

## Status
**Planned** - HIGH PRIORITY for Epic 2.5 MedSpaCy Clinical Intelligence Integration

## Story
**As a** developer implementing advanced medical NLP capabilities,  
**I want** to integrate comprehensive clinical context detection (negation, assertion, temporal context) with the MedSpaCy engine,  
**so that** the system can accurately distinguish between "patient has chest pain" vs "patient denies chest pain" and achieve >80% clinical context accuracy.

## Acceptance Criteria

1. **Negation Detection Integration**: Implement ConText algorithm for accurate negation detection in clinical statements
2. **Assertion Classification System**: Create assertion classification to distinguish between asserted, denied, and hypothetical medical conditions
3. **Temporal Context Detection**: Implement temporal context detection for current vs historical vs future medical events
4. **Clinical Safety Confidence Scoring**: Create confidence scoring system that incorporates clinical context accuracy for medical safety
5. **Medical Context Integration**: Seamlessly integrate clinical context detection with existing MedSpaCy entity extraction
6. **Clinical Context Validation**: Validate clinical context detection accuracy >80% on clinical scenarios
7. **Performance Optimization**: Maintain enhanced Tier 1 performance <15ms including clinical context detection

## Tasks / Subtasks

### Task 1: ConText Algorithm Implementation (AC: 1)
- [ ] Install and configure ConText component for MedSpaCy
  - [ ] Add medspacy ConTextComponent to clinical pipeline
  - [ ] Configure negation patterns for clinical text (no, denies, absent, negative)
  - [ ] Set up clinical negation rule sets with medical terminology
  - [ ] Create negation scope detection for clinical sentences
  - [ ] Configure ConText modifiers for clinical context windows

- [ ] Clinical negation detection implementation
  - [ ] Implement negation detection for medical conditions and symptoms
  - [ ] Create negation confidence scoring based on linguistic patterns
  - [ ] Add medical-specific negation patterns (patient denies, no evidence of, etc.)
  - [ ] Handle complex negation structures in clinical text
  - [ ] Create negation validation with clinical ground truth testing

- [ ] Advanced negation processing
  - [ ] Implement double negation handling for clinical accuracy
  - [ ] Add negation scope boundaries for multi-sentence clinical notes
  - [ ] Create negation uncertainty detection (possibly, maybe, uncertain)
  - [ ] Handle medication discontinuation vs never prescribed scenarios
  - [ ] Add clinical abbreviation negation support (neg, WNL, unremarkable)

### Task 2: Assertion Classification System (AC: 2)
- [ ] Core assertion classification framework
  - [ ] Create `ClinicalAssertionClassifier` class with medical assertion types
  - [ ] Implement assertion categories: asserted, denied, hypothetical, uncertain
  - [ ] Add clinical statement confidence scoring for assertions
  - [ ] Create assertion pattern matching for clinical language patterns
  - [ ] Integrate assertion classification with entity extraction pipeline

- [ ] Medical assertion pattern recognition
  - [ ] Clinical assertion patterns: "patient reports", "appears to have", "likely"
  - [ ] Denial patterns: "patient denies", "no history of", "rules out"
  - [ ] Hypothetical patterns: "if patient develops", "should symptoms worsen"
  - [ ] Uncertain patterns: "possibly", "may have", "cannot rule out"
  - [ ] Family history patterns: "family history of", "mother had", "genetic risk"

- [ ] Assertion confidence and validation
  - [ ] Create assertion confidence scoring with clinical context weighting
  - [ ] Implement assertion validation against clinical reasoning patterns
  - [ ] Add medical safety scoring adjustments based on assertion types
  - [ ] Create assertion conflict detection (contradictory statements)
  - [ ] Implement assertion temporal consistency checking

### Task 3: Temporal Context Detection (AC: 3)
- [ ] Clinical temporal context framework
  - [ ] Create `TemporalContextDetector` class for medical timeline detection
  - [ ] Implement temporal categories: current, historical, future, chronic
  - [ ] Add clinical temporal markers: "history of", "current", "acute", "chronic"
  - [ ] Create temporal scope detection for medical events
  - [ ] Integrate temporal context with clinical entity extraction

- [ ] Medical timeline pattern recognition
  - [ ] Historical indicators: "past medical history", "previously diagnosed"
  - [ ] Current indicators: "presenting with", "currently experiencing", "acute onset"
  - [ ] Future indicators: "follow-up", "schedule", "monitor for", "if develops"
  - [ ] Chronic indicators: "longstanding", "chronic", "ongoing", "managed"
  - [ ] Duration patterns: "for 2 weeks", "since last month", "over past year"

- [ ] Temporal relationship extraction
  - [ ] Create medical event timeline reconstruction
  - [ ] Implement temporal relationship scoring between medical entities
  - [ ] Add temporal consistency validation for clinical narratives
  - [ ] Create temporal context confidence scoring with clinical validation
  - [ ] Handle complex temporal relationships in clinical documentation

### Task 4: Clinical Safety Confidence Scoring (AC: 4)
- [ ] Clinical context confidence framework
  - [ ] Create weighted confidence scoring incorporating clinical context accuracy
  - [ ] Implement medical safety adjustments based on negation/assertion classification
  - [ ] Add temporal context impact on clinical safety scoring
  - [ ] Create clinical context uncertainty penalties for safety calculations
  - [ ] Integrate clinical context confidence with existing medical safety validation

- [ ] Medical safety context scoring
  - [ ] Higher confidence penalties for negated critical symptoms (chest pain, shortness of breath)
  - [ ] Lower confidence adjustments for historical conditions vs current active conditions
  - [ ] Hypothetical condition safety scoring (lower urgency, higher monitoring)
  - [ ] Uncertain assertion safety scoring (requires clinical confirmation)
  - [ ] Family history safety scoring (genetic risk factors, screening recommendations)

- [ ] Context-aware medical safety validation
  - [ ] Clinical context validation rules for medication safety
  - [ ] Negation validation for allergy and adverse reaction reporting
  - [ ] Temporal context validation for medication adherence and effectiveness
  - [ ] Assertion context validation for symptom severity and urgency
  - [ ] Clinical safety escalation based on context confidence thresholds

### Task 5: Medical Context Integration (AC: 5)
- [ ] Entity-context integration architecture
  - [ ] Extend existing medical entity classes with clinical context fields
  - [ ] Create `ClinicalContextualEntity` class with negation/assertion/temporal data
  - [ ] Integrate clinical context detection with MedSpaCy entity extraction pipeline
  - [ ] Update entity serialization to include clinical context metadata
  - [ ] Create clinical context visualization for debugging and validation

- [ ] Context-aware entity processing
  - [ ] Apply clinical context detection to all extracted medical entities
  - [ ] Create context-entity relationship mapping for clinical validation
  - [ ] Implement clinical context inheritance for related medical entities
  - [ ] Add context-aware entity filtering based on clinical relevance
  - [ ] Create clinical context aggregation for complex medical scenarios

- [ ] Clinical workflow integration
  - [ ] Update existing quality assessment to incorporate clinical context accuracy
  - [ ] Integrate clinical context validation with medical safety validation
  - [ ] Create clinical context reporting in API responses
  - [ ] Add clinical context confidence to escalation threshold calculations
  - [ ] Update HIPAA-compliant logging to include clinical context metadata (without PHI)

### Task 6: Clinical Context Validation Testing (AC: 6)
- [ ] Clinical context testing framework
  - [ ] Create comprehensive clinical context validation dataset
  - [ ] Include negation test cases: "no chest pain", "denies nausea", "absent bowel sounds"
  - [ ] Add assertion test cases: "likely pneumonia", "rules out MI", "possibly viral"
  - [ ] Include temporal test cases: "history of diabetes", "acute onset", "chronic condition"
  - [ ] Create complex context scenarios: "no family history of cardiac disease"

- [ ] Clinical accuracy validation
  - [ ] Test clinical context detection accuracy >80% target on validation dataset
  - [ ] Validate negation detection accuracy for critical symptoms and conditions
  - [ ] Test assertion classification accuracy for clinical decision-making scenarios
  - [ ] Validate temporal context accuracy for medical timeline reconstruction
  - [ ] Test clinical safety confidence scoring with context-aware medical scenarios

- [ ] Edge case and error scenario testing
  - [ ] Test complex negation scenarios: double negation, scope boundaries
  - [ ] Validate assertion conflicts and contradictory clinical statements
  - [ ] Test temporal inconsistencies and timeline conflicts
  - [ ] Validate clinical context detection with abbreviations and medical shorthand
  - [ ] Test clinical context accuracy with multi-condition clinical scenarios

### Task 7: Performance Optimization with Clinical Context (AC: 7)
- [ ] Clinical context processing optimization
  - [ ] Profile clinical context detection performance impact on entity extraction
  - [ ] Optimize ConText component configuration for clinical text processing
  - [ ] Create clinical context caching for repeated clinical patterns
  - [ ] Implement selective clinical context detection based on entity types
  - [ ] Add performance monitoring for clinical context detection latency

- [ ] Memory and processing efficiency
  - [ ] Optimize clinical context rule loading and pattern matching
  - [ ] Create clinical context result caching for common medical scenarios
  - [ ] Implement batch processing for clinical context detection
  - [ ] Add clinical context processing parallelization where appropriate
  - [ ] Monitor memory usage impact of clinical context detection components

- [ ] Integrated performance benchmarking
  - [ ] Test complete MedSpaCy + clinical context processing within <15ms Tier 1 target
  - [ ] Validate clinical context detection impact on overall F1 and accuracy scores
  - [ ] Benchmark clinical context accuracy vs processing time trade-offs
  - [ ] Create performance dashboards for clinical context detection metrics
  - [ ] Test scalability of clinical context detection with varying text complexity

## Dev Notes

### Clinical Context Detection Architecture

**ConText Algorithm Integration:**
The ConText algorithm is specifically designed for clinical text and provides robust negation and assertion detection. It uses linguistic patterns and scope detection to understand clinical context.

```python
# Clinical Context Detection with ConText Integration
class ClinicalContextDetector:
    def __init__(self):
        # Initialize ConText component with clinical patterns
        self.context_component = ConTextComponent(
            rules="default",  # Default clinical rules
            add_groups=True   # Group related entities
        )
        
        # Clinical assertion patterns
        self.assertion_patterns = {
            "asserted": ["patient reports", "presents with", "diagnosed with"],
            "denied": ["denies", "no", "absent", "negative for"],
            "hypothetical": ["if", "should", "would", "could"],
            "uncertain": ["possibly", "maybe", "uncertain", "unclear"],
            "family_history": ["family history", "mother had", "father died of"]
        }
        
        # Temporal context patterns
        self.temporal_patterns = {
            "current": ["currently", "presents with", "acute", "now"],
            "historical": ["history of", "previously", "past", "former"],
            "future": ["follow-up", "schedule", "monitor", "watch for"],
            "chronic": ["chronic", "longstanding", "ongoing", "managed"]
        }
    
    def detect_clinical_context(self, entity, doc) -> ClinicalContext:
        # Apply ConText negation detection
        negation = self._detect_negation(entity, doc)
        
        # Classify clinical assertions
        assertion = self._classify_assertion(entity, doc)
        
        # Detect temporal context
        temporal = self._detect_temporal_context(entity, doc)
        
        # Calculate clinical context confidence
        context_confidence = self._calculate_context_confidence(negation, assertion, temporal)
        
        return ClinicalContext(
            negation=negation,
            assertion=assertion,
            temporal=temporal,
            confidence=context_confidence,
            medical_safety_impact=self._assess_safety_impact(negation, assertion, temporal)
        )
```

### Clinical Context Data Structures

**Enhanced Entity with Clinical Context:**
```python
@dataclass
class ClinicalContextualEntity:
    # Base entity information
    text: str
    entity_type: str
    confidence: float
    start: int
    end: int
    
    # Clinical context information
    clinical_context: ClinicalContext
    medical_safety_score: float
    clinical_relevance_score: float
    
    # Context-aware properties
    @property
    def is_negated(self) -> bool:
        return self.clinical_context.negation.is_negated
    
    @property
    def is_current_condition(self) -> bool:
        return self.clinical_context.temporal.is_current
    
    @property
    def requires_clinical_attention(self) -> bool:
        # Critical conditions that are current and not negated
        return (not self.is_negated and 
                self.is_current_condition and 
                self.entity_type in ["CONDITION", "MEDICATION_REACTION"])

@dataclass
class ClinicalContext:
    negation: NegationContext
    assertion: AssertionContext  
    temporal: TemporalContext
    confidence: float
    medical_safety_impact: str

@dataclass  
class NegationContext:
    is_negated: bool
    negation_type: str  # "explicit", "implied", "uncertain"
    negation_cues: List[str]
    confidence: float

@dataclass
class AssertionContext:
    assertion_type: str  # "asserted", "denied", "hypothetical", "uncertain", "family_history"
    assertion_cues: List[str] 
    confidence: float

@dataclass
class TemporalContext:
    temporal_type: str  # "current", "historical", "future", "chronic"
    temporal_cues: List[str]
    is_current: bool
    confidence: float
```

### Clinical Context Patterns and Examples

**Negation Detection Examples:**
```python
CLINICAL_NEGATION_EXAMPLES = [
    # Explicit negation
    ("Patient denies chest pain", "chest pain", True),
    ("No shortness of breath noted", "shortness of breath", True),
    ("Absent bowel sounds", "bowel sounds", True),
    
    # Implicit negation  
    ("Patient appears comfortable", "pain", True),  # comfort implies no pain
    ("Unremarkable cardiac exam", "cardiac abnormalities", True),
    
    # Not negated
    ("Patient reports chest pain", "chest pain", False),
    ("Positive for diabetes", "diabetes", False)
]
```

**Assertion Classification Examples:**
```python
CLINICAL_ASSERTION_EXAMPLES = [
    # Asserted conditions
    ("Patient diagnosed with hypertension", "hypertension", "asserted"),
    ("Presents with acute shortness of breath", "shortness of breath", "asserted"),
    
    # Denied conditions
    ("Patient denies nausea", "nausea", "denied"),
    ("No family history of diabetes", "diabetes", "denied"),
    
    # Hypothetical conditions
    ("If patient develops rash, discontinue medication", "rash", "hypothetical"),
    ("Monitor for signs of infection", "infection", "hypothetical"),
    
    # Uncertain conditions
    ("Possibly viral syndrome", "viral syndrome", "uncertain"),
    ("Cannot rule out pneumonia", "pneumonia", "uncertain")
]
```

**Temporal Context Examples:**
```python
TEMPORAL_CONTEXT_EXAMPLES = [
    # Current conditions
    ("Patient currently experiencing chest pain", "chest pain", "current"),
    ("Acute onset of shortness of breath", "shortness of breath", "current"),
    
    # Historical conditions  
    ("Past medical history of diabetes", "diabetes", "historical"),
    ("Previously diagnosed with hypertension", "hypertension", "historical"),
    
    # Future/monitoring
    ("Schedule follow-up for blood pressure check", "blood pressure check", "future"),
    ("Monitor for medication side effects", "medication side effects", "future"),
    
    # Chronic conditions
    ("Chronic kidney disease", "kidney disease", "chronic"),
    ("Longstanding diabetes management", "diabetes", "chronic")
]
```

### Medical Safety Integration with Clinical Context

**Context-Aware Medical Safety Scoring:**
```python
class ContextAwareMedicalSafety:
    def calculate_medical_safety_score(self, entity: ClinicalContextualEntity) -> float:
        base_safety_score = entity.confidence
        
        # Adjust based on clinical context
        if entity.clinical_context.negation.is_negated:
            # Negated critical symptoms have different safety implications
            if entity.entity_type in ["SYMPTOM", "CONDITION"]:
                # Lower urgency for negated symptoms
                safety_adjustment = 0.3
            else:
                # For medications, negation might indicate non-adherence
                safety_adjustment = 0.8
        else:
            safety_adjustment = 1.0
        
        # Temporal context adjustments
        if entity.clinical_context.temporal.temporal_type == "historical":
            # Historical conditions may affect current treatment decisions
            temporal_adjustment = 0.7
        elif entity.clinical_context.temporal.temporal_type == "current":
            # Current conditions require immediate attention
            temporal_adjustment = 1.2
        else:
            temporal_adjustment = 1.0
        
        # Assertion context adjustments
        assertion_adjustments = {
            "asserted": 1.0,
            "denied": 0.4,
            "hypothetical": 0.6,
            "uncertain": 0.8,
            "family_history": 0.5
        }
        assertion_adjustment = assertion_adjustments.get(
            entity.clinical_context.assertion.assertion_type, 1.0
        )
        
        final_safety_score = (base_safety_score * 
                            safety_adjustment * 
                            temporal_adjustment * 
                            assertion_adjustment)
        
        return min(final_safety_score, 1.0)  # Cap at 1.0
```

### Performance Optimization Strategy

**Clinical Context Processing Optimization:**
- **Selective Context Detection**: Apply full clinical context detection only to medical entities
- **Pattern Caching**: Cache clinical context patterns for common medical expressions
- **Parallel Processing**: Process negation, assertion, and temporal detection in parallel
- **Context Scope Optimization**: Limit context scope to relevant sentence boundaries for performance

### Integration with Existing Architecture

**Enhanced Quality Assessment with Clinical Context:**
```python
def calculate_clinical_quality_score(self, entities: List[ClinicalContextualEntity]) -> float:
    # Existing 5-rule sufficiency system enhanced with clinical context
    base_quality = self._calculate_base_quality(entities)
    
    # Clinical context quality bonus
    context_accuracy = sum(e.clinical_context.confidence for e in entities) / len(entities)
    clinical_context_bonus = context_accuracy * 0.2  # 20% bonus for high context accuracy
    
    # Medical safety context validation
    safety_context_score = self._validate_safety_context(entities)
    
    return min(base_quality + clinical_context_bonus + safety_context_score, 1.0)

def _validate_safety_context(self, entities: List[ClinicalContextualEntity]) -> float:
    # Validate clinical context makes medical sense
    safety_violations = 0
    total_checks = 0
    
    for entity in entities:
        if entity.entity_type == "MEDICATION" and entity.clinical_context.negation.is_negated:
            # Negated medications should not be in active prescriptions
            total_checks += 1
            if not self._validate_negated_medication_context(entity):
                safety_violations += 1
    
    return (total_checks - safety_violations) / max(total_checks, 1) * 0.1  # 10% safety bonus
```

### Testing and Validation Strategy

**Clinical Context Accuracy Validation:**
```python
CLINICAL_CONTEXT_TEST_DATASET = {
    "negation_scenarios": [
        "Patient denies chest pain but reports shortness of breath",
        "No family history of diabetes, but positive for hypertension", 
        "Absent bowel sounds, present heart murmur",
        "Patient comfortable, no acute distress noted"
    ],
    
    "assertion_scenarios": [
        "Patient likely has pneumonia based on symptoms",
        "Cannot rule out myocardial infarction",
        "Definitive diagnosis of diabetes mellitus",
        "If patient develops rash, discontinue immediately"
    ],
    
    "temporal_scenarios": [
        "Past medical history significant for stroke",
        "Current medications include metformin and lisinopril",
        "Schedule follow-up in 3 months for diabetes management",
        "Chronic kidney disease stage 3, stable"
    ]
}
```

### Expected Performance Impact and Improvements

**Clinical Context Detection Performance Metrics:**
- **Processing Time Impact**: +5-8ms per extraction (8-15ms total Tier 1)
- **Clinical Context Accuracy**: Target >80% for negation, assertion, temporal detection
- **F1 Score Improvement**: Additional 5-10% improvement from accurate clinical context
- **Medical Safety Enhancement**: 40-60% improvement in clinical safety scoring
- **Clinical Relevance**: 30-50% better filtering of clinically relevant entities

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------| 
| 2025-09-12 | 1.0 | Story 2.5.2 Clinical Context Detection Integration | Winston (System Architect) |

## Dev Agent Record

### Agent Model Used
**Claude Opus 4.1** - Story 2.5.2 clinical context detection planning

### Clinical Context Architecture Notes
- **ConText Algorithm**: Industry standard for clinical negation and context detection
- **Clinical Safety Integration**: Context-aware medical safety scoring for clinical accuracy
- **Performance Optimization**: Selective context detection with pattern caching for <15ms processing
- **Medical Accuracy**: >80% clinical context detection accuracy target for production medical use
- **Integration Strategy**: Seamless integration with MedSpaCy engine and existing 4-tier architecture

### Clinical Intelligence Enhancement Strategy
- **Multi-dimensional Context**: Negation, assertion, temporal context detection for comprehensive clinical understanding
- **Medical Safety Focus**: Context-aware medical safety validation prevents clinical misinterpretation
- **Clinical Workflow Integration**: Enhanced quality assessment and escalation with clinical context confidence
- **Performance Balance**: Clinical intelligence enhancement while maintaining <15ms Tier 1 processing requirement