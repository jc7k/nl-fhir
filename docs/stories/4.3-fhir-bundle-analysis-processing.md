# Story 4.3: FHIR Bundle Analysis & Processing

## Story Overview

**Epic:** Epic 4 - FHIR Bundle Summarization  
**Story ID:** 4.3  
**Title:** FHIR Bundle Analysis & Processing  
**Status:** Ready for Development  
**Estimate:** 5 story points  
**Sprint:** Sprint 4 Week 3  

## User Story

**As a** system processing HAPI-validated FHIR bundles  
**I want** intelligent analysis and clinical element extraction  
**So that** LLM prompts contain accurate, well-structured clinical information for summarization  

## Acceptance Criteria

### AC1: FHIR Resource Parsing
- [ ] **GIVEN** a HAPI-validated FHIR bundle with various resource types
- [ ] **WHEN** the system parses bundle entries
- [ ] **THEN** it correctly extracts clinical data from each resource type
- [ ] **AND** converts structured FHIR fields to human-readable clinical elements

### AC2: Clinical Element Extraction  
- [ ] **GIVEN** FHIR resources (MedicationRequest, ServiceRequest, Observation)
- [ ] **WHEN** extracting clinical information
- [ ] **THEN** it produces natural language descriptions for medications, labs, and procedures
- [ ] **AND** includes all clinically relevant details (dosage, frequency, indication, urgency)

### AC3: Complexity Assessment
- [ ] **GIVEN** various FHIR bundle compositions
- [ ] **WHEN** analyzing bundle complexity
- [ ] **THEN** it correctly identifies simple vs complex vs emergency scenarios
- [ ] **AND** provides complexity indicators for schema selection

### AC4: Urgency Detection
- [ ] **GIVEN** FHIR resources with priority fields or emergency indicators
- [ ] **WHEN** analyzing clinical urgency
- [ ] **THEN** it correctly identifies urgent, stat, or emergency orders
- [ ] **AND** flags time-sensitive actions requiring immediate attention

## Technical Requirements

### FHIR Bundle Analysis Engine

**Core Analyzer Class:**
```python
class FHIRBundleAnalyzer:
    def analyze_bundle_content(self, fhir_bundle: Dict[str, Any]) -> BundleAnalysis:
        # Comprehensive bundle analysis
        
    def assess_complexity(self, analysis: BundleAnalysis) -> ComplexityLevel:
        # Determine clinical complexity level
        
    def detect_urgency_indicators(self, resources: List[Dict]) -> UrgencyAssessment:
        # Identify time-sensitive orders
```

**Bundle Analysis Data Structure:**
```python
@dataclass
class BundleAnalysis:
    resource_count: int
    has_medications: bool
    has_lab_orders: bool  
    has_procedures: bool
    has_emergency_indicators: bool
    complexity_indicators: List[str]
    urgency_level: str
    high_risk_medications: List[str]
    clinical_specialties: List[str]
```

### Clinical Element Extraction

**Medication Processing:**
```python
class MedicationExtractor:
    def extract_medication_info(self, medication_request: Dict) -> MedicationElement:
        return MedicationElement(
            name=self._extract_medication_name(medication_request),
            dosage=self._extract_dosage_instruction(medication_request), 
            frequency=self._extract_frequency(medication_request),
            indication=self._extract_clinical_indication(medication_request),
            safety_notes=self._assess_medication_safety(medication_request)
        )
```

**Laboratory Order Processing:**
```python  
class LabOrderExtractor:
    def extract_lab_info(self, service_request: Dict) -> LabElement:
        return LabElement(
            test_name=self._extract_test_description(service_request),
            clinical_reason=self._extract_indication(service_request),
            urgency=self._extract_priority_level(service_request),
            special_prep=self._extract_preparation_requirements(service_request)
        )
```

**Procedure Processing:**
```python
class ProcedureExtractor:
    def extract_procedure_info(self, service_request: Dict) -> ProcedureElement:
        return ProcedureElement(
            procedure_name=self._extract_procedure_name(service_request),
            clinical_purpose=self._extract_indication(service_request),
            urgency=self._extract_priority_level(service_request), 
            location_notes=self._extract_location_info(service_request)
        )
```

### FHIR Resource Field Mapping

**MedicationRequest Field Extraction:**
- `medicationCodeableConcept` → Natural medication name
- `dosageInstruction[0].doseAndRate` → Human-readable dosage  
- `dosageInstruction[0].timing` → Frequency description
- `reasonCode` → Clinical indication
- `status` → Order status

**ServiceRequest Field Extraction:**
- `code.text` → Test/procedure description
- `priority` → Urgency level (routine, urgent, stat)
- `category` → Service type (lab, imaging, procedure)  
- `reasonCode` → Clinical indication
- `specimen` → Sample requirements (for labs)

### Complexity Assessment Logic

**Simple Bundle Criteria:**
- ≤3 resources total
- Single resource type (medications only)
- No urgent/stat priorities
- No high-risk medications

**Complex Bundle Criteria:**  
- >5 resources total
- Mixed resource types (meds + labs + procedures)
- Multiple clinical specialties involved
- High-risk medications or procedures

**Emergency Bundle Criteria:**
- Any resource with "stat" or "urgent" priority
- Emergency medication keywords (epinephrine, cardioversion, etc.)
- Critical lab orders (troponin, blood gas, etc.)

## Implementation Details

### File Structure
```
src/nl_fhir/services/
├── bundle_analyzer.py                  # Main bundle analysis engine
├── clinical_extractors/
│   ├── medication_extractor.py         # Medication-specific extraction
│   ├── lab_extractor.py               # Laboratory order extraction  
│   └── procedure_extractor.py         # Procedure extraction
├── fhir_field_mappings.py             # FHIR resource field definitions
└── complexity_assessor.py             # Bundle complexity analysis
```

### Clinical Element Data Models

```python
@dataclass 
class MedicationElement:
    name: str
    dosage: str
    frequency: str  
    indication: Optional[str]
    safety_notes: List[str]
    high_risk: bool

@dataclass
class LabElement:
    test_name: str
    clinical_reason: str
    urgency: str
    special_prep: Optional[str]
    sample_type: Optional[str]

@dataclass  
class ProcedureElement:
    procedure_name: str
    clinical_purpose: str
    urgency: str
    location_notes: Optional[str]
    preparation_required: bool
```

### High-Risk Detection

**High-Risk Medications:**
- Anticoagulants (warfarin, heparin, DOACs)
- Insulin and diabetes medications
- Cardiac medications (digoxin, antiarrhythmics)
- Chemotherapy agents
- Controlled substances

**High-Risk Procedures:**
- Invasive procedures requiring consent
- Emergency interventions
- Procedures requiring special preparation

## Testing Requirements

### Unit Tests
- [ ] Test FHIR resource parsing for each resource type
- [ ] Validate clinical element extraction accuracy
- [ ] Test complexity assessment logic with various bundle types
- [ ] Verify urgency detection with different priority levels

### Integration Tests
- [ ] End-to-end bundle analysis with real FHIR bundles from Epic 3
- [ ] Test clinical element extraction with complex multi-resource bundles
- [ ] Validate schema selection based on analysis results
- [ ] Test error handling with malformed or incomplete FHIR resources

### Clinical Validation Tests
- [ ] Physician review of extracted clinical elements for accuracy
- [ ] Validation of natural language conversion from FHIR structured data
- [ ] Confirmation that complexity assessment matches clinical reality

### Test Data Requirements
- Sample FHIR bundles representing different clinical scenarios
- Edge cases: empty bundles, single resources, mixed priorities
- Real-world FHIR bundles from various clinical specialties
- High-risk medication and procedure examples

## Definition of Done

- [ ] FHIR bundle analysis engine processes all common resource types
- [ ] Clinical element extraction produces accurate natural language descriptions  
- [ ] Complexity assessment correctly categorizes bundle types for schema selection
- [ ] Urgency detection identifies time-sensitive orders reliably
- [ ] High-risk medication and procedure detection working accurately
- [ ] Unit tests achieve >90% code coverage
- [ ] Integration tests validate with real FHIR bundles
- [ ] Clinical validation completed by physician review
- [ ] Error handling covers malformed FHIR resource scenarios
- [ ] Code review completed and approved

## Dependencies

**Blocked By:**
- Epic 3 completion (HAPI-validated FHIR bundles as input)
- Story 4.1 (needs schema selection logic integration)

**Blocks:**  
- Story 4.4 (API Integration) - requires clinical element extraction

**External Dependencies:**
- FHIR R4 specification knowledge
- Clinical terminology understanding for natural language conversion

## Clinical Review Requirements

**Physician Validation Needed For:**
- Accuracy of clinical element extraction
- Natural language conversion quality  
- Complexity assessment clinical appropriateness
- High-risk detection completeness and accuracy

**Clinical Scenarios to Test:**
- Routine medication orders
- Emergency department orders  
- Complex multi-specialty cases
- Laboratory-focused orders
- Procedure-heavy bundles

## Notes for Development

**Key Implementation Guidelines:**
1. **FHIR Compliance:** Follow FHIR R4 specification for field access
2. **Natural Language:** Convert all structured data to clinical language
3. **Clinical Accuracy:** Preserve all medically relevant information
4. **Error Resilience:** Handle missing or malformed FHIR fields gracefully

**Performance Considerations:**
- Bundle analysis should complete in <50ms for typical bundles
- Cache extracted elements to avoid re-processing 
- Optimize for common FHIR resource patterns

**Clinical Safety:**
- Never lose critical clinical information during extraction
- Flag high-risk scenarios prominently
- Maintain traceability from FHIR data to extracted elements